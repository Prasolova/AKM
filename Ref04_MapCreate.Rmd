# Составление географической карты {#map-create}

## Исходные данные {#map-create-initial-data}

[Бланк задания](https://yadi.sk/i/6zLIWLFZI2frhA){target="_blank"}

## Создание базы пространственных данных {#map-create-database}
[В начало справки ⇡](#map-create)

Составление карты подразумевает, прежде всего, создание векторных наборов данных.

> **Векторные данные** – данные, которые описываются набором координат.

Подробнее о них вы узнаете из курса _Основы геоинформатики_. На данный момент нам необходимо знать, что векторные объекты могут относиться к трём _основным_ типам геометрии: 1) точечные; 2) линейные; 3) полигональные.

> **Классы объектов** – это наборы однородных векторных данных одного типа геометрии с одним набором атрибутов, относящие к одному роду пространственных объектов или явлений. Например, на почвенной карте будет визуализироваться класс полигональных объектов почв, класс полигональных объектов механического состава, класс внемасштабных почвенных ареалов.

> **Атрибут класса объектов** – это формализованное описание какого-либо свойства класса объектов. Атрибутов может быть много, каждый из них отвечает за различные аспекты пространственных объектов или явлений. У класса почв это может быть атрибут типа, подтипа, pH, содержания гумуса, мощности и т.д. Атрибуты строго типизируются, то есть при создании указывается тип данных, который будет храниться в атрибутивном поле: _целочисленные данные_, _действительные числа_, _числа с плавающей точкой_, _логические значения_, _текстовые данные_ и ряд других.

QGIS поддерживает различные форматы пространственных данных. Среди них наиболее удобным и современным для хранения и работы считается формат **Geopackage**. По сути это формат базы пространственных данных, внутри которой мы можем складывать различные классы объектов. Для создания базы данных формата **Geopackage** откройте окно Браузера внутри QGIS. Если его нет, включите его в выпадающем списке при щелчке правой кнопкой мыши по пустой панели. Найдите каталог, в котором вы хотите создать базу данных (лучше всего, чтобы путь к этой базы состоял из символов латинского алфавита, не содержал дефисов, пробелов и спецсимволов). Правой кнопкой мыши щелкните по каталогу, выберете **Новые – Geopackage**. Откроется окно, которое помимо самой базы данных предложит создать класс объектов внутри неё. В поле Имя таблицы введите имя класса объектов латинскими символами, лучше, чтобы это был английский перевод соответствующего вида картографируемого объекта, а не транслитерация.


![Окно создания базы данных Geopackage](images/Ref04/Create_gpkg.png)


В поле **Тип геометрии** укажите соответствующую геометрию объектов.
Укажите спроецированную систему координат. Если указать геодезическую систему координат, то велика вероятность, что при векторизации объектов возникнут курьёзные ситуации.
В разделе **New Field** можно указать имя, типа и длину атрибутивного поля создаваемого класса объектов.

Каждый последующий класс объектов создавайте внутри базы данных. Таким образом вы сформируете единое хранилище для всех картографируемых объектов.

## Векторизация {#map-create-vectorize}
[В начало справки ⇡](#map-create)

Созданные классы объектов в базе данных можно добавить в перечень слоев проекта простым перетаскиванием, либо дважды щёлкнув по ним в Браузере. Для редактирования объектов и добавления новых объектов в класс необходимо войти в режим редактирования. Для этого можно щелкнуть правой кнопкой мыши по слою и выбрать пункт **Режим редактирования**, либо выделить слой и найти на панели инструментов кнопку ![](images/Ref04/Edit.png). Активация режима редактирования откроет некоторые другие кнопки на панелях. Например, для полигонального объекта появится кнопка ![](images/Ref04/New_polygon.png), с помощью которой можно создать новый полигон в слое. Для других типов геометрии иконка будет немного отличаться.


Рисовка контура осуществляется с помощью левой кнопки мыши. Для завершения рисовки объекта нажмите правую кнопку мыши. Для редактирования отдельных вершин нажмите на кнопку ![](images/Ref04/Vertices.png). После этого у объекта кружочками выделятся вершины.


![Полигон в режиме отображения вершин](images/Ref04/Polygon.png)


Курсор в таком режиме может вести себя тремя разными способами:

1)	При выделении вершины вы можете изменить её положение

2)	При выделении ребра вы можете сдвинуть его вместе со смежными вершинами

3)	При нажатии на плюсик в центре ребра добавляется новая вершина

Нажатие на клавишу **DELETE** позволяет удалить вершину.

При векторизации объектов часто возникает необходимость пристыковать вершины одного объекта к вершинам другого объекта. Для корректной и комфортной пристыковки нужно включить панель Инструменты прилипания (**snapping**). Кнопка в виде магнита ![](images/Ref04/Snapping.png) активирует прилипание. Остальные кнопки на данной панели позволяют уточнить параметры прилипания, в том числе расстояние, на котором оно начинает действовать.

Если вам необходимо повторить значительную часть существующего контура при создании нового, то удобнее всего воспользоваться трассировкой (**Tracing**), нажав на кнопку ![](images/Ref04/Tracing.png) на панели инструментов прилипания. После этого при ведении на небольшом расстоянии от контура новый контур будет автоматически пристыковываться к существующем.


![Пример работы с инструментом трассировки](images/Ref04/Tracing.gif)


_Дополнительные инструменты оцифровки_


Соответствующую панель вы так же, как и предыдущую, можете найти в выпадающем списке панелей.


![Дополнительная панель векторизации](images/Ref04/Additional_panel.png)


На данной панели доступны инструменты для векторизации параллельных и перпендикулярных линий, для перемещения объектов, создания внутренних колец (по сути – дырки в полигоне), разрезания объектов, склеивания объектов и другие.


Выбрать объекты, например, для склеивания можно с помощью инструмента выделения ![](images/Ref04/Selection_tool.png).


Не забывайте регулярно сохранять изменения в геометрии слоев с помощью кнопки на панели ![](images/Ref04/Save_edits.png). Также не забывайте изменять изменения в самом проекте (они касаются набора слоев, их оформления, некоторых параметров) с помощью кнопки ![](images/Ref04/Save_project.png).


## Работа с атрибутами {#map-create-attributes}
[В начало справки ⇡](#map-create)

Векторизация предназначена для показа геометрической составляющей объектов и явлений на карте. Для показа семантических (смысловых) различий в явлениях используются атрибуты. Преимущество ГИС-пакетов по сравнению с графическими пакетами заключается в том, что мы можем напрямую сопоставить символику слоя и значения атрибутивных полей. Например, если мы показываем качественным фоном какое-либо явление, то каждой явление должно иметь своё значение в атрибутивной таблице. Открыть атрибутивную таблицу слоя можно, нажав правой кнопкой мыши по нему и выбрав пункт **Открыть таблицу атрибутов**.


![Выделение строк атрибутивной таблицы на регионы России](images/Ref04/Attribute_table.gif)


Для редактирования атрибутов необходимо зайти в режим редактирования с помощью кнопки ![](images/Ref04/Edit.png). Для добавления или удаления атрибутивных столбцов также необходимо зайтив в режим редактирования, после чего появятся соответствующие кнопки ![](images/Ref04/New_field.png) и ![](images/Ref04/Delete_field.png).

> Обратите внимание, что изменение структуры атрибутивной таблицы в режиме редактирования – это исключительно «фишка» QGIS. Другие известные ГИС-пакеты, например ArcGIS, позволяют это делать только вне режима редактирования.

Обратите внимание, что каждая строка в атрибутивной таблице – это, по сути, один объект в классе объектов. Выделять объекты в атрибутивной таблицы можно с помощью нажатия левой кнопки мыши по левому краю строки. Для выбора нескольких строк подряд можно «тянуть» выделение левой кнопкой мыши, либо выделить первый и последний объект с зажатым **SHIFT**. Для выбора нескольких отдельных строк зажмите **CTRL**. Выделяемые в атрибутивной таблице объекты будут подсвечиваться жёлтым цветом на карте. Для приближения к выбранному объекту нажмите на кнопку **Увеличить карту до выделенных строк** ![](images/Ref04/Zoom_to_selection.png).


## Настройка символики {#map-create-symbology}
[В начало справки ⇡](#map-create)

### Использование простой символики {#map-create-symbology-simple}

#### Единая символика {-}

По умолчанию все слои, открываемые в QGIS имеют единую символику для всех объектов слоя. Для площадных классов объектов это сплошная заливка какого-либо цвета. Получить доступ к настройкам стиля можно через свойства слоя во вкладке **Стиль**. Обратите внимание, что способ подобной символики указан в самом верху окна и называется **Обычный знак**.


![Единый символ в виде сплошной цветовой заливки](images/Ref04/Single_symbol.png)


Мы можем задавать более сложную символику для наших объектов, то есть не только цветовую заливку и обводку. Построение таких символов в QGIS осуществляется в виде иерархии. Например, для добавления штриховки поверх цвета вам нужно нажать кнопку ![](images/Ref04/Plus.png), расположенную справа от окна самого символа в настройках стиля. После этого в символе появится второй слой, также по умолчанию залитый сплошной цветовой заливкой. **Тип слоя** можно поменять на штриховку, либо на другой вариант символики.

> В терминологии QGIS **штриховкой** называется любой паттерн (графическая структура), состоящий из линейных элементов. Штриховка, состоящая из нелинейных (точечных) элементов, называется **заливкой маркерами**.


![Типы слоёв символики](images/Ref04/Layer_type.gif)


Обратите внимание, что при выборе типа слоя в виде штриховки его символ распадётся на иерархические элементы – собственно _заливка штриховкой_ и составляющие её _линии_. Для заливки штриховки доступны свойства наклона (**Вращение**), интервала (**Отступа**) и **смещения**.


![Символика штриховки](images/Ref04/Hatching.png)


Если выделять последовательно в иерархии символа **Линия** и **Простая линия**, то вы увидете, что для них доступны разные настройки. В первом случае нам доступны уже стилизованные линии, во втором случае – простая заготовка линии, для которой можно настроить **стиль обводки** – сплошная линия, пунктирная, штриховая и т.д.


![Настройки простой линии](images/Ref04/Simple_line.png)


Для заливки маркерами нужно выбрать соответствующий тип слоя. После этого появится аналогичная штриховке иерархия графических слоёв. Для настройки пользователю доступны параметры самой заливки – расстояния и смещения маркеров, а также параметры маркеров – тип слоя маркеров, размер маркера, цвет и другие. Для добавления пользовательских маркеров используйте тип слоя **SVG-маркеры**, для которых можно подгрузить собственные графические символы в формате SVG.


![Настройки маркеров для заливки](images/Ref04/Marker_fill.png)


#### Уникальные значения {-}
[В начало справки ⇡](#map-create)

Рассмотрим, каким образом мы ставим в соответствие значения атрибутивных полей и символики. Например, мы хотим присвоить разные цвета для всех регионов. В самой верхней строчке нужно выбрать **Уникальные значения**, после чего указать в строке **Value** атрибутивное поле, значения которого мы будем использовать. В строке **Градиент** можно выбрать заранее заготовленные цветовые шкалы, в том числе и случайные цвета. Для добавления всех значений из атрибутивного поля с присвоенными цветами нажмите на кнопку **Классифицировать** внизу окна. После применения выбранной классификации в окне слоёв наш слой будет показа соответствующим образом, как в легенде.


![Классификация по уникальным значениям со случайной цветовой шкалой](images/Ref04/Unique_values.png)


Вы можете подбирать цвета для категорий вручную, если дважды щёлкните по цветовой шашке. Обратите внимание, что вы можете вместо сплошной цветовой заливки использовать заливку штриховку, менять настройки обводки.


![Изменение цвета символа](images/Ref04/Manual_fill.png)


#### Цветовые шкалы {-}
[В начало справки ⇡](#map-create)

Для создания градуированных цветовых шкал в случае использования в качестве способов изображения изолиний с послойной окраской, картограмм, количественного фона используется стиль **градуированного знака**.


![Настройки стиля градуированных знаков](images/Ref04/Graduated_colors.png)


В окошке **градиент** можно выбрать соответствующий градиент. Если вы хотите создать новый градиент – щёлкните правой кнопкой мыши по окошку и выберите **Создать новый градиент...**, либо **Редактировать градиент...**. Внизу окна свойств стиля вы можете увидеть настройку классификации **Мода**, а также количество классов. Подробнее о разных методах классификации и о работе с гистограммой вы узнаете из курсов _Основы геоинформатики_ и _Аэрокосмические методы географических исследований_.

#### Градуированные значки {-}
[В начало справки ⇡](#map-create)

Для значков в качестве графической переменной зачастую выступает размер. Зайдите в стиль точечного слоя и укажите тип стиля **Градуированный знак**. В поле **Value** укажите атрибутивное поле, по которому будет строится шкала. Нажмите на кнопку со значком по умолчанию – откроется отдельное окно настройки маркера. Вы можете выбрать простой маркер из предложенных, либо выставить тип слоя **SVG-маркер** – внизу окна появится библиотека встроенных символов, которые можно использовать в качестве маркера. Пользователю доступна настройка цвета и размера маркера.


![Выбор и настройка SVG-маркера](images/Ref04/SVG_marker.gif)


Далее вы можете использовать выбранный маркер в качестве значка. Укажите **Метод** – **Size** (построение шкалы по размеру), укажите минимальный и максимальный размер символа. Внизу укажите количество **Классов** и нажмите на кнопку **Классифицировать**.


![Настройка градуированного размеру значка](images/Ref04/Graduated_marker.png)



### Использование графических средств диаграмм {#map-create-symbology-charts}
[В начало справки ⇡](#map-create)


Для построения диаграмм нужно перейти в соответствующую вкладку свойств слоя (они расположены отдельно от стиля). В самом верху можно выбрать тип диаграммы – круговая, столбчатая или текстовая.


![Доступные виды диаграмм](images/Ref04/Charts.png)


#### Построение круговых диаграмм {-}
[В начало справки ⇡](#map-create)

Для построения круговых диаграмм необходимо выбрать соответствующий тип вверху окна. В атрибутах задаются те атрибутивные поля, которые будут содержать значения для отдельных секторов диаграммы.


![Выбор атрибутивных полей для диаграммы](images/Ref04/Pie_chart_attributes.png)


Добавление полей осуществляется двойным нажатием на поле. Справа возможна ручная настройка цвета сектора. В разделе **Размер** задаётся размер диаграммы, то есть некое абсолютное число. Размер может быть **Фиксированный**, то есть постоянный для всех диаграмм, либо **Масштабируемый**, то есть зависящий от значений в атрибутивных полях класса.


![Настройка размера диаграммы](images/Ref04/Pie_chart_size.png)


Размер может определяться конкретным атрибутивным полем, которое можно выбрать из списка, либо, если вы хотите получать значение, например, на основе суммы входящих в диаграмму значений, нажмите на ![](images/Ref04/Expression.png). После нажатия на кнопку откроется окно **Expression dialog**, которое ещё называется калькулятором полей. Для составления выражения из атрибутивных полей найдите в центральном окошке категорию **Поля и значения** и выберите нужные поля двойным щелчком мыши. Названия полей появятся слева, вам остаётся только расставить нужные арифметические операторы между ними.

> Обратите внимание, что, помимо выражений с существующими полями, можно рассчитывать, например, площадь, обратясь к категории **Геометрия** и выбрав функцию **$area**.

В окошке **Макс. значение** можно обозначить максимальное значение показателя, которое будет использоваться в градации, либо использовать расчётное максимальное значение – для этого нажмите на кнопку **Найти**.

В окошке **Размер** указывается абсолютное значение максимального размера диаграммы. Его можно масштабировать как площадь, либо как диаметр круга (указывается справа).


![Настройка размещения диаграммы](images/Ref04/Pie_chart_location.png)


В настройках размещения можно указать способ привязки диаграммы к полигону. Имейте в виду, что центроид не всегда располагается внутри полигона.


![Настройка легенды диаграммы](images/Ref04/Pie_chart_legend.png)


В настройках легенды можно выбрать вид диаграммы в легенде. Обратите внимание, что в качестве символа диаграммы может быть выбран любой значок – он не имеет отношения к изображению диаграммы на карте. Используя пункт **Collapsed legend**, мы совмещаем диаграммы разных размером вместе, что удобнее для восприятия их размера. Внизу опция **Align symbols** позволяет выравнить диаграммы разного размера либо по нижней точке, либо по центру. В окне **Заголовка** мы можете написать соответствующий заголовок для пункта легенды. Ставя галочку для **Manual size classes**, пользователю открывается возможность добавлять нужное количество градаций и подбирать для них нужные подписи в колонке **Метка**.

Пример вида с диаграммой показан на рисунке. Аналогичным образом можно построить диаграммы для значкового способа изображения.


![](images/Ref04/Pie_chart_map.png)


## Настройка подписей {#map-create-labeling}
[В начало справки ⇡](#map-create)

Подписи так же, как и символика в геоинформационном программном обеспечении зависят от атрибутов. Для включения подписей в слое зайдите в его свойства и найдите вкладку **Подписи**.


![настройка подписей](images/Ref04/Labels.png)


В поле **Value** указывается атрибутивное поле, из которого подтягиваются сами подписи. Ниже приведены классические настройки для текст – шрифт, размер, стиль, цвет и т.д. Особое внимание при составлении карты следует уделить размещению подписей, чему посвящена отдельная вкладка настроек подписей.


![Размещение подписей](images/Ref04/Labels_location.png)


К сожалению, возможностей по оптимальному автоматическому размещению подписей в QGIS не так много. Пользователь может вручную править размещение подписей – для этого необходимо обратиться к специальной панели ![](images/Ref04/Labels_panel.png). Для перемещения подписей нажмите на кнопку ![](images/Ref04/Labels_move.png). Вместо курсора на карте появится крест, которым нужно щёлкнуть по нужной подписи. После этого откроется диалоговое окно:


![](images/Ref04/Auxiliary_Storage_dialog.png)


После нажатия на **OK** вы сможете перетаскивать подписи одним щелчком мыши. Аналогично после нажатия кнопки ![](images/Ref04/Labels_rotate.png) подписи можно разворачивать, а после нажатия кнопки ![](images/Ref04/Labels_edit.png) – редактировать. Для редактирования открывается отдельное окно, где можно индивидуально настроить параметры каждой подписи.


![Параметры подписи](images/Ref04/Labels_properties.png)


## Имитация некоторых сложных графических средств и способов изображения {#map-create-fake-symbology}
[В начало справки ⇡](#map-create)

Некоторые способы изображения трудно реализуемы в ГИС-пакетах. Например, точечный способ есть в ArcGIS, но QGIS он пока отсутствует. Если всё же есть необходимость в использовании данного способа изображения, то можно его сымитировать, хотя с точки зрения базы данных это будет не совсем корректно – вместо полигонального слоя (явление площадной рассеянной локализации) создайте точечный слой, в котором каждая точка будет соответствовать одной точке на карте. Веса точек можно задать с помощью атрибутов.

Сложные диаграммы невозможно сделать ни в одном ГИС-пакете. Для их имитации можно подготовить векторное представление диаграммы в формате **SVG** и добавить в QGIS в качестве SVG-маркера.

## Работа с легендой в компоновке {#map-create-legend}
[В начало справки ⇡](#map-create)

В макете карты вы можете добавлять столько элементов легенды (кнопка ![](images/Ref04/Add_legend.png)), сколько отдельных блоков легенды в компоновке вы хотите сделать. Следует помнить, что в QGIS легенда собирается автоматически из содержания слоёв проекта, но пользователь может поменять её свойства.


![Свойства легенды в макете](images/Ref04/Legend_properties.png)


Если убрать галочку возле опции **Auto update**, то из перечня слоёв легенды можно убрать лишние слои или отдельные позиции, либо добавить отсутствующие с помощью кнопок ниже.  С помощью кнопки ![](images/Ref04/Legend_edit_item.png) можно редактировать текст легенды.

## Редактирование карты в графическом пакете {#map-create-inkscape}
[В начало справки ⇡](#map-create)

Для редактирования карты в графическом пакете можно использовать открытое ПО **Inkscape**. Экспортируйте макет вашей карты из QGIS в формате **SVG** и откройте файл в Inkscape. Каждый элемент карты теперь представлен как графика, что позволяет вручную их перемещать, редактировать с помощью инструмента ![](images/Ref04/Inkscape_picker.png). Редактировать вершины объектов можно с помощью инструмента ![](images/Ref04/Inkscape_vertices.png).


----
_Карпачевский А.М._ **Картография: практикум в QGIS**. М.: Географический факультет МГУ, `r lubridate::year(Sys.Date())`.
----